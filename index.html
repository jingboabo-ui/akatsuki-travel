<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Êõâ„ÉªÈõ≤Á´ØÊà∞Áï• App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Inter:wght@900&display=swap" rel="stylesheet">
    <style>
        body { background-color: #F2F2F2; font-family: 'Inter', sans-serif; }
        .neo-brutalism { border: 4px solid #000; box-shadow: 6px 6px 0px #000; transition: all 0.1s; cursor: pointer; }
        .neo-brutalism:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px #000; }
        .akatsuki-bg-red { background-color: #D32F2F; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .date-btn-active { background-color: #000 !important; color: #fff !important; }
    </style>
</head>
<body x-data="app()" x-init="initData()">

    <header class="p-4 pt-10 flex justify-between items-center bg-white border-b-4 border-black">
        <h1 class="text-2xl font-black italic">AKATSUKI <span class="text-red-600">CORE</span></h1>
        <button @click="initData()" class="p-2 border-2 border-black font-black text-xs">REFRESH</button>
    </header>

    <main class="p-4 pb-32">
        <template x-if="tab === 'home'">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-4 bg-black text-white neo-brutalism col-span-2">
                        <p class="text-[10px] text-red-600 font-bold uppercase">Flight Info</p>
                        <div class="mt-2 text-sm font-bold">
                            ÂéªÁ®ãÔºö<span x-text="getInfo('Flight_Go')"></span><br>
                            ÂõûÁ®ãÔºö<span x-text="getInfo('Flight_Back')"></span>
                        </div>
                    </div>
                    <div class="p-4 bg-white neo-brutalism col-span-2">
                        <p class="text-[10px] text-gray-400 font-bold uppercase">Accommodation</p>
                        <p class="font-black text-lg" x-text="getInfo('Hotel_Name')"></p>
                        <p class="text-xs font-bold mt-1" x-text="getInfo('Hotel_Addr')"></p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div @click="tab = 'schedule'" class="col-span-2 p-6 bg-white neo-brutalism flex justify-between items-center">
                        <span class="text-3xl font-black italic">Ë°åÁ®ãÊôÇÈñìËª∏</span>
                        <span class="text-2xl">‚Üí</span>
                    </div>
                    <div @click="tab = 'budget'" class="p-6 bg-white neo-brutalism flex flex-col justify-between aspect-square">
                        <span class="text-4xl font-black text-red-600">¬•</span>
                        <span class="font-black">Â§ö‰∫∫Ë®òÂ∏≥</span>
                    </div>
                    <div @click="tab = 'checklist'" class="p-6 bg-white neo-brutalism flex flex-col justify-between aspect-square">
                        <span class="text-4xl">üìú</span>
                        <span class="font-black">ÂøÖÂÇôÊ∏ÖÂñÆ</span>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="tab === 'schedule'">
            <div class="space-y-4">
                <div class="flex overflow-x-auto space-x-2 pb-4 no-scrollbar">
                    <template x-for="date in uniqueDates">
                        <button @click="selectedDate = date" 
                                :class="selectedDate === date ? 'date-btn-active' : ''"
                                class="px-6 py-3 bg-white border-4 border-black font-black whitespace-nowrap" 
                                x-text="date"></button>
                    </template>
                </div>
                <div class="border-l-8 border-black ml-3 pl-6 space-y-6">
                    <template x-for="item in filteredSchedule">
                        <div class="p-4 bg-white neo-brutalism relative">
                            <div class="absolute -left-10 top-5 w-4 h-4 bg-red-600 border-2 border-black rounded-full"></div>
                            <p class="text-xl font-black text-red-600 italic" x-text="item.Time"></p>
                            <h3 class="text-xl font-black mt-1" x-text="item.Activity"></h3>
                            <p class="text-xs font-bold text-gray-500 mt-2 bg-gray-100 p-2 border-l-4 border-black" x-text="item.Note"></p>
                        </div>
                    </template>
                </div>
            </div>
        </template>

        <template x-if="tab === 'budget'">
            <div class="space-y-4">
                <div class="p-6 bg-black text-white neo-brutalism">
                    <p class="text-xs text-red-600 font-bold uppercase">CNY To TWD</p>
                    <div class="text-6xl font-black text-right mt-2 truncate" x-text="cnyInput || '0'"></div>
                    <p class="text-right text-red-600 font-black text-xl mt-4">‚âà NT$ <span x-text="Math.round(cnyInput * 4.5)"></span></p>
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <template x-for="n in ['1','2','3','4','5','6','7','8','9','C','0','SAVE']">
                        <button @click="handleInput(n)" class="p-6 bg-white neo-brutalism font-black text-2xl h-20" :class="n === 'SAVE' ? 'akatsuki-bg-red text-white' : ''" x-text="n"></button>
                    </template>
                </div>
            </div>
        </template>

        <template x-if="tab === 'checklist'">
            <div class="space-y-6">
                <template x-for="cat in ['APP', 'Ticket', 'Other']">
                    <div>
                        <h2 class="text-xl font-black bg-black text-white px-2 inline-block mb-3" x-text="cat"></h2>
                        <div class="space-y-2">
                            <template x-for="item in db.Checklist.filter(i => i.Type === cat)">
                                <div class="p-3 bg-white border-2 border-black flex items-center">
                                    <input type="checkbox" class="w-5 h-5 border-2 border-black mr-3">
                                    <span class="font-bold" x-text="item.Item"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    </main>

    <template x-if="showSaveModal">
        <div class="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-[100]">
            <div class="bg-white p-6 neo-brutalism w-full max-w-sm space-y-4">
                <h3 class="text-xl font-black">Ë™∞‰ªòÁöÑÈå¢Ôºü</h3>
                <div class="flex gap-4">
                    <button @click="payer = 'ÂÆúÈùú'" :class="payer === 'ÂÆúÈùú' ? 'akatsuki-bg-red text-white' : 'bg-gray-100'" class="flex-1 py-3 font-black border-2 border-black">ÂÆúÈùú</button>
                    <button @click="payer = 'Ê≥∞ÂÑí'" :class="payer === 'Ê≥∞ÂÑí' ? 'akatsuki-bg-red text-white' : 'bg-gray-100'" class="flex-1 py-3 font-black border-2 border-black">Ê≥∞ÂÑí</button>
                </div>
                <h3 class="text-xl font-black pt-2">‰ªò‰∫Ü‰ªÄÈ∫ºÔºü</h3>
                <input type="text" x-model="note" class="w-full p-3 border-4 border-black font-bold" placeholder="‰æãÂ¶ÇÔºöÊµ∑Â∫ïÊíà„ÄÅÂú∞ÈêµÁ•®...">
                <div class="flex gap-2">
                    <button @click="showSaveModal = false" class="flex-1 py-3 font-black bg-gray-200">ÂèñÊ∂à</button>
                    <button @click="confirmSave()" class="flex-1 py-3 font-black akatsuki-bg-red text-white">Á¢∫Ë™çÂÑ≤Â≠ò</button>
                </div>
            </div>
        </div>
    </template>

    <footer class="fixed bottom-6 left-0 right-0 px-6 flex justify-center pointer-events-none">
        <button @click="tab = 'home'" class="w-full max-w-xs py-4 akatsuki-bg-red text-white neo-brutalism font-black text-xl tracking-[0.3em] pointer-events-auto">
            Êõâ„ÉªÈ¶ñÈ†Å
        </button>
    </footer>

<script>
        function app() {
            // ‚ö†Ô∏è Ë´ãÁ¢∫‰øùÈÄôË£°Ë≤º‰∏ä‰Ω†Ê∏¨Ë©¶ÊàêÂäüÁöÑÈÇ£‰∏≤ /exec Á∂≤ÂùÄ
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxYyVQh6b76YpR4YziRt7nuDEMc0wxJVfOaIZMcOqipvn908IHcOIP96DXwm_2gpUGPzg/exec"; 

            return {
                tab: 'home', cnyInput: '', db: { Schedule: [], TravelInfo: [], Checklist: [] },
                selectedDate: '', showSaveModal: false, payer: 'ÂÆúÈùú', note: '',
                SCRIPT_URL: SCRIPT_URL,

                async initData() {
                    try {
                        const res = await fetch(this.SCRIPT_URL);
                        const data = await res.json();
                        
                        // üõ†Ô∏è Ê†∏ÂøÉ‰øÆÂæ©ÔºöËôïÁêÜ Google ÁöÑ ISO Êó•ÊúüÊ†ºÂºè‰∏¶‰øÆÊ≠£ÊôÇÂ∑Æ
                        this.db.Schedule = (data.Schedule || []).map(item => {
                            let d = new Date(item.Date);
                            if (!isNaN(d.getTime())) {
                                // ‰øÆÊ≠£ Google Â∞éÂá∫ÁöÑÊôÇÂ∑ÆÂïèÈ°åÔºåÁ¢∫‰øùÊó•ÊúüËàáË©¶ÁÆóË°®‰∏ÄËá¥
                                if (item.Date.toString().includes('T')) {
                                    d.setHours(d.getHours() + 8); 
                                }
                                item.Date = d.toISOString().split('T')[0];
                            }
                            return item;
                        });

                        this.db.TravelInfo = data.TravelInfo || [];
                        this.db.Checklist = data.Checklist || [];
                        
                        // ÂàùÂßãÈ°ØÁ§∫Á¨¨‰∏ÄÂ§©ÁöÑË°åÁ®ã
                        if (this.uniqueDates.length > 0) {
                            this.selectedDate = this.uniqueDates[0];
                        }
                    } catch (e) {
                        console.error("Ë≥áÊñôËÆÄÂèñÂ§±Êïó", e);
                    }
                },
                get uniqueDates() {
                    // ÊäìÂèñÊâÄÊúâ‰∏çÈáçË§áÁöÑÊó•Êúü‰∏¶ÊéíÂ∫è
                    const dates = [...new Set(this.db.Schedule.map(i => i.Date.toString()))];
                    return dates.filter(d => d && d !== "null").sort();
                },
                get filteredSchedule() {
                    return this.db.Schedule.filter(i => i.Date === this.selectedDate);
                },
                getInfo(cat) {
                    const item = this.db.TravelInfo.find(i => i.Category === cat);
                    return item ? item.Detail : 'Â∞öÊú™Â°´ÂØ´';
                },
                handleInput(n) {
                    if (n === 'C') this.cnyInput = '';
                    else if (n === 'SAVE') { if(this.cnyInput) this.showSaveModal = true; }
                    else if (this.cnyInput.length < 8) this.cnyInput += n;
                },
                async confirmSave() {
                    const payload = {
                        cny: this.cnyInput, twd: Math.round(this.cnyInput * 4.5),
                        payer: this.payer, note: this.note
                    };
                    try {
                        await fetch(this.SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                        alert('Â∑≤Ë®òÂ∏≥Ëá≥Èõ≤Á´ØÔºÅ');
                        this.showSaveModal = false; this.cnyInput = ''; this.note = '';
                    } catch (e) { alert('ÂÑ≤Â≠òÂ§±Êïó'); }
                }
            }
        }
    </script>